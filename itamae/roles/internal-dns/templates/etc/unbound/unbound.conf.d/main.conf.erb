server:
  interface: 0.0.0.0
  access-control: 127.0.0.0/8 allow
  access-control: 10.8.0.0/16 allow
  access-control: ::1 allow
  access-control: 2406:da14:37f:7c00::/56 allow
  access-control: 2001:df0:8500:a700::/56 allow
  access-control: 240b:250:8020:d00::/64 allow

  private-address: 10.8.0.0/16
  private-domain: iii.dark-kuins.net.
  domain-insecure: iii.dark-kuins.net.
  private-domain: local.

  val-permissive-mode: yes

<%
def full(name:, kind:, region:)
  "#{name}.#{kind}.#{region}.iii.dark-kuins.net"
end
def rrset(type:, fqdn:, value:, ttl: 600)
  %Q(local-data: "#{fqdn} #{ttl} IN #{type} #{value}")
end
def iii_short(name:, kind:, region:)
  to = full(name: name, kind: kind, region: region)
  [
    rrset(type: 'CNAME', fqdn: "#{name}.#{kind[0]}.#{region}.iii.dark-kuins.net", value: to),
    rrset(type: 'CNAME', fqdn: "#{name}.#{kind[0]}.#{region[0]}.iii.dark-kuins.net", value: to),
  ]
end
def iii_a(name:, kind:, region:, to:)
  iii_short(name: name, kind: kind, region: region) + [
    rrset(type: 'A', fqdn: full(name: name, kind: kind, region: region), value: to)
  ]
end
def iii_cname(name:, kind:, region:, to:)
  iii_short(name: name, kind: kind, region: region) + [
    rrset(type: 'CNAME', fqdn: full(name: name, kind: kind, region: region), value: to)
  ]
end
%>
local-zone: "10.in-addr.arpa." static

local-zone: "iii.dark-kuins.net." static
local-data: "iii.dark-kuins.net. "
<%=
  @iii.map do |host|
    case host[:type]
    when 'a' then
      iii_a(name: host[:name], kind: host[:kind], region: host[:region], to: host[:to]).join ?\n
    when 'cname' then
      iii_cname(name: host[:name], kind: host[:kind], region: host[:region], to: host[:to]).join ?\n
    else
      raise "unknown type: #{host[:type]}"
    end
  end.join ?\n
%>
